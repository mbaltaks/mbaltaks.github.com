---
layout: post
title: Making Plone work with Apache and Active Directory on Mac OS X
date: 2006-12-18
comments: false
---

<h1>{{ page.title }}</h1>
<div class='post'>
I posted a comment at http://plone.org/documentation/how-to/singlesignonwindowsdomains updating the instructions there to work with mod_rewrite, since zope's fastcgi support is on the way out. Here's the post:<br /><br />As of December 2006, Plone is at 2.5.1, Zope is 2.9.6 and Apache is 2.2.3. Zope 2.9 has depreciated fastcgi altogether, and apache 2.2 won't work nicely with mod_fastcgi (mod_fcgid works, but doesn't support the FastCgiExternalServer needed for zope with fastcgi). So I needed to keep using mod_ntlm, but use it with mod_rewrite rather than fastcgi. And I've made it work! <br /><br />Assuming a plone site in zope called /plone, here is some apache 2.2 config that works with mod_rewrite, mod_proxy (and mod_proxy_http) and mod_headers. <br /><br /><Location /zope/plone> <br /># Use this line instead (with the lines below) to have plone at the web site root. <br />#<Location /plone> <br />AuthName "Active Directory Domain" <br />AuthType NTLM <br />NTLMAuth on <br />NTLMAuthoritative on <br />NTLMDomain domain <br />NTLMServer domain-controller-1 <br />NTLMBackup domain-controller-2 <br />require valid-user <br /></Location> <br /><br />LoadModule proxy_module modules/mod_proxy.so <br />LoadModule proxy_http_module modules/mod_proxy_http.so <br />RewriteEngine On <br />RewriteCond %{LA-U:REMOTE_USER} (.+) <br />RewriteRule ^/zope/(.*) \ <br />http://localhost:8080/VirtualHostBase/http/%{SERVER_NAME}:80/VirtualHostRoot/_vh_zope/$1 \ <br />[L,P,E=RU:%1] <br /># Use these alternatives with the alternative Location above to put plone at the root. <br />#RewriteRule ^/(.*) \ <br />#http://localhost:8080/VirtualHostBase/http/%{SERVER_NAME}:80/VirtualHostRoot/$1 \ <br />#[L,P,E=RU:%1] <br />RequestHeader set X_REMOTE_USER %{RU}e <br /><br />To make mod_ntlm work correctly with this reverse proxy config, I had to make some changes, which are now in the trunk of subversion at the source forge project. svn co https://modntlm.svn.sourceforge.net/svnroot/modntlm/trunk - this is the same code as found at http://modntlm.jamiekerwick.co.uk/ with a patch to fix reverse proxy auth. <br /><br />On the zope/plone side, I had to install apachepas (http://dev.plone.org/collective/browser/PASPlugins/apachepas, svn co http://svn.plone.org/svn/collective/PASPlugins/apachepas) into the products folder and add it to the acl_users folder for the plone instance. Make sure you put the contents of the trunk folder into a folder called "apachepas" in the products folder. I also needed LDAPMultiPlugins (http://www.dataflake.org/software/ldapmultiplugins) which might depend on LDAPUserFolder (http://www.dataflake.org/software/ldapuserfolder) - both just need to be copied into the products folder and then LDAPMultiPlugins added to the acl_users folder in the plone instance. Configuring the LDAPUserFolder within LDAPMultiPlugins is up to you, since it depends on your directory layout. I suggest talking to an (Active, e-, Open) Directory expert, and using an LDAP browser to get the settings right before going to the LDAPUserFolder. <br /><br />As a starting point, here's the schema I used for Active Directory: <br />LDAP, Friendly name, maps to, multi <br />----------------------------------- <br />objectGUID, AD Object GUID, objectGUID, No <br />cn, Canonical Name, , No <br />dn, Distinguished Name, dn, No <br />givenName, First Name, first_name, No <br />memberOf, Group DNs, memberOf, Yes <br />sn, Last Name, last_name, No <br />sAMAccountName, Windows Login Name, windows_login_name, No <br />mail, Email address, email, No <br />displayName, Full Name, fullname, No <br /><br />Then make Login Name Attribute and User ID Attribute use sAMAccountName. <br />Match all the Zope groups with LDAP groups, if required. <br />Activate all the plugins for all the types (Authentication, Extraction, etc) <br />Now you can search for users and add them to groups. <br />That was it. <br /><br /><br /><br />For reference, I also made the fastcgi method work before I attempted this, using SharkbyteSSOPlugin (http://plone.org/products/single-sign-on-plugin/releases/0.5/sharkbytessoplugin-0-5-tar.gz) in place of apachepas. I had to set SharkbyteSSOPlugin to use REMOTE_USER, rather than X_REMOTE_USER, but all the other setup was the same. This was with Apache 1.3.37 and mod_fastcgi SNAP-0404142202 and my patched mod_ntlm, and patched FCGIServer.py for Zope. <br /><br />--- /usr/local/zope/lib/python/ZServer/FCGIServer.py 2006-10-03 01:53:27.000000000 +1000 <br />+++ ./FCGIServer.py 2006-11-22 23:01:19.000000000 +1100 <br />@@ -466,6 +466,11 @@ <br />user_name = '-' <br />else: <br />user_name = t[0] <br />+ if string.lower(http_authorization[:5]) == 'ntlm ': <br />+ # The user_name is set elsewhere <br />+ user_name = "ntlm user" <br />+ else: <br />+ user_name = "Unsupported HTTP Auth type" <br />else: <br />user_name='-' <br />if self.addr: <br /><br />Save the above to zope-fcgi-ntlm.patch then run: <br />patch -p0 $PREFIX/zope/lib/python/ZServer/FCGIServer.py zope-fcgi-ntlm.patch</div>
<h2>Comments</h2>
<div class='comments'>
</div>
